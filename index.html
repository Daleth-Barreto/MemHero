<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemHero: EXPROM 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#050011',
                        'panel': '#0f172a',
                        'neon-cyan': '#00f3ff',
                        'neon-pink': '#ff00ff',
                        'neon-yellow': '#ffe600',
                        'neon-green': '#00ff66',
                        'neon-red': '#ff0033',
                        'retro-purple': '#240046',
                    },
                    fontFamily: {
                        arcade: ['"Press Start 2P"', 'cursive'],
                        cyber: ['"Orbitron"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'sun-glow': 'sunGlow 4s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        sunGlow: {
                            'from': { boxShadow: '0 0 40px #ff00ff, 0 0 80px #ff00ff inset' },
                            'to': { boxShadow: '0 0 60px #ff00ff, 0 0 100px #ff00ff inset' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020005;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        /* --- BACKGROUND FX "EXPROM EDITION" --- */
        .world-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            perspective: 1000px;
            overflow: hidden;
            z-index: -1;
            background: linear-gradient(to bottom, #120024 0%, #000000 100%);
        }

        /* Retro Sun */
        .retro-sun {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #ffe600 0%, #ff00ff 50%, #7000ff 100%);
            mask-image: linear-gradient(to bottom, black 0%, black 60%, transparent 60%, transparent 65%, black 65%, black 70%, transparent 70%, transparent 75%, black 75%, black 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 0%, black 50%, transparent 55%, black 60%, transparent 65%, black 70%, transparent 75%, black 80%, transparent 85%, black 90%);
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.6);
            animation: sun-glow 4s infinite alternate;
            z-index: 0;
        }

        /* Moving Grid Floor */
        .cyber-grid {
            position: absolute;
            bottom: -50%;
            left: -50%;
            width: 200%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.4) 2px, transparent 2px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.4) 2px, transparent 2px);
            background-size: 80px 80px;
            transform: rotateX(70deg);
            transform-origin: 50% 0;
            animation: gridScroll 3s linear infinite;
            box-shadow: 0 -50px 100px rgba(0, 243, 255, 0.2);
            z-index: 1;
        }

        @keyframes gridScroll {
            0% { background-position: 0 0; }
            100% { background-position: 0 80px; }
        }

        /* Stars / Particles */
        .stars {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white 1px, transparent 1px),
                radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            opacity: 0.3;
            z-index: 0;
        }

        /* Mountains Silhouette (CSS Only) */
        .mountains {
            position: absolute;
            bottom: 30%; /* Align with horizon */
            left: 0; width: 100%; height: 100px;
            background: 
                linear-gradient(135deg, transparent 50%, #050011 50%) 0 0 / 100px 100px,
                linear-gradient(225deg, transparent 50%, #050011 50%) 0 0 / 120px 120px;
            background-repeat: repeat-x;
            opacity: 0.8;
            z-index: 1;
        }

        /* --- UI ELEMENTS --- */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        .menu-btn {
            position: relative;
            transition: all 0.2s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        
        .menu-btn.selected {
            background: #fff !important;
            color: #000 !important;
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255,255,255,0.8);
            z-index: 10;
        }

        .note {
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
            box-shadow: 0 0 15px currentColor;
            z-index: 10;
        }

        .key-hint {
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            background: rgba(0,0,0,0.5);
        }

        /* Hit Zone */
        .hit-zone-line {
            height: 4px;
            background: rgba(255,255,255,0.6);
            box-shadow: 0 0 15px white, 0 0 30px #00f3ff;
            position: absolute;
            left: 0; right: 0;
            bottom: 200px;
            transition: all 0.1s;
        }
        
        .hit-zone-line.active {
            background: #fff;
            height: 6px;
            box-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
        }
    </style>
</head>
<body class="h-screen flex flex-col font-cyber">

    <!-- BACKGROUND WORLD -->
    <div class="world-container">
        <div class="stars"></div>
        <div class="retro-sun"></div>
        <div class="mountains"></div>
        <div class="cyber-grid"></div>
        <!-- Horizon Line -->
        <div style="position: absolute; bottom: 30%; left:0; width:100%; height:2px; background:#00f3ff; box-shadow:0 0 20px #00f3ff; z-index:2;"></div>
    </div>

    <!-- AUDIO TOGGLE -->
    <button id="btnAudio" onclick="toggleAudio()" class="absolute top-4 right-4 z-50 text-xs text-gray-400 hover:text-white font-arcade border border-gray-700 bg-black/50 p-2 hover:border-white transition backdrop-blur-sm">
        [M] SONIDO: OFF
    </button>

    <!-- 1. MAIN MENU -->
    <div id="screenMenu" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6">
        <div class="relative z-10 animate-float">
            <h1 class="text-6xl md:text-9xl font-arcade text-transparent bg-clip-text bg-gradient-to-b from-white via-neon-cyan to-neon-pink mb-2 drop-shadow-[0_0_25px_rgba(0,243,255,0.6)] text-center tracking-tighter">
                MEM_HERO
            </h1>
            <div class="bg-black/80 text-neon-yellow font-arcade text-xs md:text-sm tracking-[0.5em] uppercase px-4 py-2 border border-neon-yellow inline-block absolute -bottom-6 left-1/2 transform -translate-x-1/2 shadow-[0_0_15px_rgba(255,230,0,0.5)] whitespace-nowrap">
                EXPROM 2025 EDITION
            </div>
        </div>

        <div class="flex flex-col gap-6 w-full max-w-md mt-20" id="menuList">
            <div class="menu-item menu-btn bg-black/80 border-l-4 border-neon-yellow p-6 text-center cursor-pointer hover:bg-white/10" data-algo="FIFO">
                <h3 class="text-2xl font-bold text-neon-yellow font-arcade drop-shadow-md">FIFO</h3>
                <p class="text-gray-400 text-xs mt-2 font-mono">Dificultad: FÁCIL</p>
            </div>
            
            <div class="menu-item menu-btn bg-black/80 border-l-4 border-neon-cyan p-6 text-center cursor-pointer hover:bg-white/10" data-algo="LRU">
                <h3 class="text-2xl font-bold text-neon-cyan font-arcade drop-shadow-md">LRU</h3>
                <p class="text-gray-400 text-xs mt-2 font-mono">Dificultad: MEDIA</p>
            </div>

            <div class="menu-item menu-btn bg-black/80 border-l-4 border-neon-pink p-6 text-center cursor-pointer hover:bg-white/10" data-algo="OPT">
                <h3 class="text-2xl font-bold text-neon-pink font-arcade drop-shadow-md">OPT</h3>
                <p class="text-gray-400 text-xs mt-2 font-mono">Dificultad: DIFÍCIL</p>
            </div>
        </div>
        
        <div class="mt-16 text-gray-500 text-[10px] font-arcade text-center opacity-80 bg-black/50 p-4 rounded-lg border border-gray-800 backdrop-blur-sm">
            <span class="text-neon-cyan">MENÚ:</span> FLECHAS & ENTER &nbsp;|&nbsp; <span class="text-neon-pink">JUEGO:</span> 1, 2, 3 / A, S, D
        </div>
    </div>

    <!-- 2. BRIEFING -->
    <div id="screenBriefing" class="hidden absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-6 backdrop-blur-md">
        <div class="glass-panel max-w-2xl w-full p-10 rounded-xl relative border-t-4 shadow-[0_0_50px_rgba(0,0,0,0.8)]" id="briefCard">
            <h2 id="briefTitle" class="text-6xl font-arcade mb-8 text-white drop-shadow-[0_0_10px_currentColor]">ALGORITMO</h2>
            
            <div class="space-y-8 font-cyber text-xl">
                <p id="briefDesc" class="text-gray-200 leading-relaxed border-l-4 border-white pl-6">...</p>
                <div class="bg-gradient-to-r from-white/10 to-transparent p-6 rounded border-l-4 border-neon-green">
                    <h4 class="text-neon-green text-sm uppercase font-bold mb-2 tracking-widest font-arcade">ESTRATEGIA</h4>
                    <p id="briefStrat" class="text-white font-bold">...</p>
                </div>
                <div class="flex items-center gap-2 text-xs text-neon-red font-mono mt-4 bg-black/40 p-2 rounded">
                    <span class="animate-pulse">⚠️</span>
                    <span>ADVERTENCIA: Velocidad incremental. Un solo error destruye la página.</span>
                </div>
            </div>

            <div class="mt-10 pt-6 border-t border-gray-700 flex justify-between items-center">
                <div class="text-xs text-gray-500 font-arcade">PRESIONA [ENTER] PARA INICIAR</div>
                <button onclick="startGame()" class="bg-white text-black font-arcade py-4 px-10 hover:bg-neon-cyan hover:scale-105 transition shadow-[0_0_20px_white]">START</button>
            </div>
        </div>
    </div>

    <!-- 3. GAME HUD -->
    <div id="gameHUD" class="hidden absolute top-0 left-0 right-0 p-4 flex justify-between items-start z-40 pointer-events-none">
        <div class="glass-panel px-6 py-3 rounded-br-2xl border-l-4 border-neon-cyan">
            <div class="text-[10px] text-gray-400 uppercase font-arcade mb-1">Algoritmo</div>
            <div id="hudAlgo" class="text-2xl font-bold font-cyber text-white drop-shadow-md">--</div>
        </div>

        <div class="flex flex-col items-center pt-4">
             <div id="feedbackText" class="h-12 text-5xl font-arcade text-white drop-shadow-[0_0_20px_white] transition-transform scale-0 italic"></div>
             <div class="text-5xl font-arcade text-neon-yellow mt-4 drop-shadow-[0_0_10px_rgba(255,230,0,0.8)]" id="hudScore">0000</div>
             <div class="text-[10px] text-neon-red font-arcade animate-pulse mt-2 bg-black/50 px-2 rounded" id="speedIndicator">SPEED: 100%</div>
        </div>

        <div class="glass-panel px-6 py-3 rounded-bl-2xl text-right border-r-4 border-neon-green">
             <div class="text-[10px] text-gray-400 uppercase font-arcade mb-1">Combo</div>
             <div id="hudCombo" class="text-2xl font-bold text-neon-green drop-shadow-md">x1</div>
        </div>
    </div>

    <!-- 4. GAME AREA -->
    <div id="screenGame" class="hidden flex-1 relative flex flex-col h-full z-10">
        
        <!-- HIGHWAY -->
        <div class="relative flex-1 w-full max-w-4xl mx-auto border-l-2 border-r-2 border-white/10 bg-gradient-to-b from-transparent to-black/90 overflow-hidden backdrop-blur-[2px]">
            
            <!-- Target Line -->
            <div id="visualHitLine" class="hit-zone-line"></div>
            <div class="absolute bottom-[205px] left-4 text-[10px] text-neon-cyan font-arcade opacity-70 tracking-widest">TARGET ZONE</div>

            <!-- Notes Layer -->
            <div id="layerNotes" class="absolute inset-0 pointer-events-none"></div>

            <!-- Queue Preview -->
            <div class="absolute top-24 right-6 w-32 hidden md:block opacity-80">
                <div class="text-[10px] text-neon-cyan mb-2 font-arcade text-right bg-black/50 px-2 rounded inline-block float-right">NEXT UP</div>
                <div class="clear-both"></div>
                <div id="queueList" class="flex flex-col gap-2 items-end mt-2"></div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="h-44 bg-black/90 border-t border-white/20 z-40 flex justify-center items-center gap-6 p-4 pb-10 shadow-[0_-10px_50px_rgba(0,0,0,1)]">
            
            <!-- FRAME 0 -->
            <div id="btn-0" class="relative w-36 h-36 bg-gray-900 border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center group transition-transform duration-75 shadow-lg">
                <div class="absolute top-2 right-2 flex gap-1"><span class="key-hint text-[10px]">1</span><span class="key-hint text-[10px]">A</span></div>
                <div class="text-[10px] text-gray-500 font-arcade mb-2">MARCO 0</div>
                <div id="val-0" class="text-5xl font-arcade text-white z-10 drop-shadow-md">--</div>
                <div id="bar-0" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all duration-300 rounded-b-xl"></div>
                <!-- Active Glow -->
                <div class="absolute inset-0 rounded-xl bg-neon-yellow/0 group-[.active-press]:bg-neon-yellow/20 transition duration-75"></div>
            </div>

            <!-- FRAME 1 -->
            <div id="btn-1" class="relative w-36 h-36 bg-gray-900 border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center group transition-transform duration-75 shadow-lg">
                <div class="absolute top-2 right-2 flex gap-1"><span class="key-hint text-[10px]">2</span><span class="key-hint text-[10px]">S</span></div>
                <div class="text-[10px] text-gray-500 font-arcade mb-2">MARCO 1</div>
                <div id="val-1" class="text-5xl font-arcade text-white z-10 drop-shadow-md">--</div>
                <div id="bar-1" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all duration-300 rounded-b-xl"></div>
                <div class="absolute inset-0 rounded-xl bg-neon-cyan/0 group-[.active-press]:bg-neon-cyan/20 transition duration-75"></div>
            </div>

            <!-- FRAME 2 -->
            <div id="btn-2" class="relative w-36 h-36 bg-gray-900 border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center group transition-transform duration-75 shadow-lg">
                <div class="absolute top-2 right-2 flex gap-1"><span class="key-hint text-[10px]">3</span><span class="key-hint text-[10px]">D</span></div>
                <div class="text-[10px] text-gray-500 font-arcade mb-2">MARCO 2</div>
                <div id="val-2" class="text-5xl font-arcade text-white z-10 drop-shadow-md">--</div>
                <div id="bar-2" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all duration-300 rounded-b-xl"></div>
                <div class="absolute inset-0 rounded-xl bg-neon-pink/0 group-[.active-press]:bg-neon-pink/20 transition duration-75"></div>
            </div>

        </div>
    </div>

    <!-- 5. GAME OVER -->
    <div id="screenOver" class="hidden absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center backdrop-blur-sm">
        <h2 class="text-6xl md:text-8xl text-neon-red font-arcade mb-8 animate-pulse text-center leading-tight drop-shadow-[0_0_30px_red]">SYSTEM<br>FAILURE</h2>
        
        <div class="glass-panel p-12 rounded-2xl text-center border-2 border-neon-red w-full max-w-lg shadow-[0_0_100px_rgba(255,0,0,0.2)]">
            <p class="text-gray-400 font-arcade text-xs uppercase mb-4 tracking-widest">Puntuación Final</p>
            <p id="finalScore" class="text-7xl text-white font-arcade mb-10 drop-shadow-glow">0</p>
            
            <div class="flex flex-col gap-6">
                <button onclick="restartGame()" class="bg-white text-black py-4 font-bold uppercase hover:bg-neon-green hover:scale-105 transition font-arcade text-sm shadow-[0_0_20px_rgba(255,255,255,0.5)]">
                    ↻ REINTENTAR
                </button>
                <button onclick="goToMenu()" class="bg-transparent border-2 border-gray-600 text-gray-300 py-4 font-bold uppercase hover:border-white hover:text-white hover:scale-105 transition font-arcade text-sm">
                    ← MENÚ PRINCIPAL
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = false;

        function toggleAudio() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('btnAudio');
            if (soundEnabled) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                btn.innerText = "[M] SONIDO: ON";
                btn.className = "absolute top-4 right-4 z-50 text-xs text-neon-green font-arcade border border-neon-green bg-black/50 p-2 hover:bg-neon-green/10 transition backdrop-blur-sm shadow-[0_0_10px_#00ff66]";
                playSound('select');
            } else {
                btn.innerText = "[M] SONIDO: OFF";
                btn.className = "absolute top-4 right-4 z-50 text-xs text-gray-500 hover:text-white font-arcade border border-gray-700 bg-black/50 p-2 hover:border-white transition backdrop-blur-sm";
            }
        }

        const sounds = {
            select: { freq: 440, type: 'square', dur: 0.1 },
            move: { freq: 220, type: 'sawtooth', dur: 0.05 },
            hit: { freq: 880, type: 'sine', dur: 0.1, slide: 1200 },
            load: { freq: 600, type: 'square', dur: 0.15 },
            replace: { freq: 400, type: 'sawtooth', dur: 0.2 },
            error: { freq: 100, type: 'sawtooth', dur: 0.3, slide: 50 },
            over: { freq: 150, type: 'sawtooth', dur: 1.0, slide: 20 }
        };

        function playSound(name) {
            if (!soundEnabled) return;
            const s = sounds[name];
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = s.type;
            osc.frequency.setValueAtTime(s.freq, audioCtx.currentTime);
            if (s.slide) osc.frequency.exponentialRampToValueAtTime(s.slide, audioCtx.currentTime + s.dur);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + s.dur);
        }

        // --- GAME CONSTANTS ---
        const BASE_SPEED = 180; 
        const MAX_SPEED = 700;
        const HIT_TOLERANCE = 55;

        // --- STATE ---
        let state = {
            screen: 'MENU',
            algo: 'FIFO',
            selectedMenuIdx: 0,
            active: false,
            score: 0,
            combo: 1,
            memory: [null, null, null],
            meta: [0, 0, 0],
            queue: [],
            notes: [],
            lastTime: 0,
            spawnTimer: 0,
            idCounter: 0,
            currentSpeed: BASE_SPEED
        };

        // --- MENU SYSTEM ---
        const menuItems = document.querySelectorAll('.menu-item');
        
        function updateMenuSelection() {
            menuItems.forEach((el, idx) => {
                if (idx === state.selectedMenuIdx) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function handleMenuInput(key) {
            if (key === 'ArrowDown' || key === 's') {
                state.selectedMenuIdx = (state.selectedMenuIdx + 1) % menuItems.length;
                playSound('move');
                updateMenuSelection();
            } else if (key === 'ArrowUp' || key === 'w') {
                state.selectedMenuIdx = (state.selectedMenuIdx - 1 + menuItems.length) % menuItems.length;
                playSound('move');
                updateMenuSelection();
            } else if (key === 'Enter') {
                const algo = menuItems[state.selectedMenuIdx].getAttribute('data-algo');
                playSound('select');
                prepareBriefing(algo);
            }
        }

        // --- BRIEFING ---
        function prepareBriefing(algo) {
            state.screen = 'BRIEF';
            state.algo = algo;
            
            document.getElementById('screenMenu').classList.add('hidden');
            document.getElementById('screenBriefing').classList.remove('hidden');
            
            const title = document.getElementById('briefTitle');
            const desc = document.getElementById('briefDesc');
            const strat = document.getElementById('briefStrat');
            const card = document.getElementById('briefCard');

            title.innerText = algo;
            
            if (algo === 'FIFO') {
                title.className = "text-6xl font-arcade mb-6 text-neon-yellow drop-shadow-[0_0_15px_#ffe600]";
                card.style.borderColor = '#ffe600';
                desc.innerText = "First-In, First-Out. Las páginas entran en orden. La víctima es la MÁS VIEJA (la que llegó primero).";
                strat.innerText = "REEMPLAZA LA BARRA ROJA MÁS LLENA.";
            } else if (algo === 'LRU') {
                title.className = "text-6xl font-arcade mb-6 text-neon-cyan drop-shadow-[0_0_15px_#00f3ff]";
                card.style.borderColor = '#00f3ff';
                desc.innerText = "Least Recently Used. Basado en uso real. La víctima es la que hace MÁS TIEMPO que no se usa.";
                strat.innerText = "HIT = REFRESCO. REEMPLAZA LA BARRA ROJA MÁS LLENA.";
            } else {
                title.className = "text-6xl font-arcade mb-6 text-neon-pink drop-shadow-[0_0_15px_#ff00ff]";
                card.style.borderColor = '#ff00ff';
                desc.innerText = "Optimal. Mira al futuro. La víctima es la que tardará MÁS TIEMPO en volver a necesitarse.";
                strat.innerText = "MIRA LA LISTA 'NEXT UP'. ELIMINA LA QUE NO ESTÉ O ESTÉ AL FONDO.";
            }
        }

        // --- GAME CONTROLS ---
        function startGame() {
            playSound('select');
            state.screen = 'GAME';
            document.getElementById('screenBriefing').classList.add('hidden');
            document.getElementById('screenOver').classList.add('hidden');
            document.getElementById('gameHUD').classList.remove('hidden');
            document.getElementById('screenGame').classList.remove('hidden');
            
            document.getElementById('hudAlgo').innerText = state.algo;
            let color = state.algo === 'FIFO' ? 'text-neon-yellow' : (state.algo === 'LRU' ? 'text-neon-cyan' : 'text-neon-pink');
            document.getElementById('hudAlgo').className = `text-2xl font-bold font-cyber ${color} drop-shadow-md`;

            resetState();
            generateQueue();
            state.active = true;
            state.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function restartGame() {
            playSound('select');
            state.screen = 'GAME';
            document.getElementById('screenOver').classList.add('hidden');
            resetState();
            generateQueue();
            state.active = true;
            state.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function goToMenu() {
            playSound('select');
            state.screen = 'MENU';
            document.getElementById('screenOver').classList.add('hidden');
            document.getElementById('screenGame').classList.add('hidden');
            document.getElementById('gameHUD').classList.add('hidden');
            document.getElementById('screenMenu').classList.remove('hidden');
            resetState();
            updateMenuSelection();
        }

        function resetState() {
            state.score = 0;
            state.combo = 1;
            state.memory = [null, null, null];
            state.meta = [0, 0, 0];
            state.queue = [];
            state.notes = [];
            state.spawnTimer = 0;
            state.currentSpeed = BASE_SPEED;
            document.getElementById('layerNotes').innerHTML = '';
            updateHUD();
            updateFrames();
        }

        // --- GLOBAL INPUT ---
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'm') toggleAudio();

            if (state.screen === 'MENU') {
                handleMenuInput(e.key);
                return;
            }
            if (state.screen === 'BRIEF') {
                if (e.key === 'Enter') startGame();
                return;
            }
            if (state.screen === 'GAME') {
                const key = e.key.toLowerCase();
                const map = { 
                    '1': 0, 'a': 0,
                    '2': 1, 's': 1,
                    '3': 2, 'd': 2
                };
                if (map.hasOwnProperty(key)) {
                    handleGameInput(map[key]);
                    const btn = document.getElementById(`btn-${map[key]}`);
                    btn.classList.add('active-press', 'border-white'); 
                    setTimeout(() => btn.classList.remove('active-press', 'border-white'), 100);
                }
            }
        });

        // --- CORE LOOP ---
        function generateQueue() {
            state.queue = [];
            for(let i=0; i<150; i++) {
                if (i>3 && Math.random() < 0.5) state.queue.push(state.queue[i-1] || 0);
                else state.queue.push(Math.floor(Math.random() * 8));
            }
            updateQueueVis();
        }

        function gameLoop(timestamp) {
            if (!state.active) return;
            const dt = (timestamp - state.lastTime) / 1000;
            state.lastTime = timestamp;
            updateGame(dt);
            requestAnimationFrame(gameLoop);
        }

        function updateGame(dt) {
            // Speed up
            if (state.currentSpeed < MAX_SPEED) state.currentSpeed += (dt * 8); 
            document.getElementById('speedIndicator').innerText = `SPEED: ${Math.round((state.currentSpeed/BASE_SPEED)*100)}%`;

            // Spawn
            state.spawnTimer -= dt;
            if (state.spawnTimer <= 0 && state.queue.length > 0) {
                spawnNote();
                // Spawn rate gets faster
                const rate = Math.max(0.6, 2.2 - ((state.currentSpeed - BASE_SPEED) / 400)); 
                state.spawnTimer = rate; 
            }

            // Move
            const highway = document.getElementById('screenGame');
            const containerH = highway.clientHeight - 160; 
            const targetY = containerH - 40; 
            
            let activeInZone = false;

            state.notes.forEach(note => {
                note.y += state.currentSpeed * dt;
                note.el.style.top = `${note.y}px`;

                const dist = Math.abs((note.y + 30) - targetY);
                if (dist < HIT_TOLERANCE && !note.missed) activeInZone = true;

                if (!note.missed && note.y > targetY + HIT_TOLERANCE + 30) {
                    note.missed = true;
                    handleMiss(note);
                }
            });

            // Target Line FX
            const line = document.getElementById('visualHitLine');
            if (activeInZone) line.classList.add('active');
            else line.classList.remove('active');

            state.notes = state.notes.filter(n => n.y < containerH + 300);

            if (state.queue.length === 0 && state.notes.length === 0) endGame();
        }

        function spawnNote() {
            const val = state.queue.shift();
            updateQueueVis();
            
            const el = document.createElement('div');
            let color = state.algo === 'FIFO' ? 'bg-neon-yellow border-neon-yellow text-black' : 
                        (state.algo === 'LRU' ? 'bg-neon-cyan border-neon-cyan text-black' : 'bg-neon-pink border-neon-pink text-black');
            
            el.className = `note absolute border-4 font-bold flex items-center justify-center text-3xl ${color} shadow-[0_0_20px_currentColor]`;
            el.style.width = '70px';
            el.style.height = '70px';
            el.innerText = val;
            el.style.top = '-80px'; 
            document.getElementById('layerNotes').appendChild(el);

            state.notes.push({
                id: state.idCounter++,
                val: val,
                y: -80,
                el: el,
                missed: false
            });
        }

        function handleGameInput(frameIdx) {
            const containerH = document.getElementById('screenGame').clientHeight;
            // Target is calculated from bottom: 200px CSS relative to highway container.
            // Highway is flex-1 above 176px controls.
            // Let's refine target logic based on visual line.
            const line = document.getElementById('visualHitLine');
            const lineRect = line.getBoundingClientRect();

            let activeNote = null;
            let minDist = Infinity;

            state.notes.forEach(n => {
                if (n.missed) return;
                const noteRect = n.el.getBoundingClientRect();
                const noteCenter = noteRect.top + (noteRect.height / 2);
                const lineCenter = lineRect.top + (lineRect.height / 2);
                const dist = Math.abs(noteCenter - lineCenter);

                if (dist < HIT_TOLERANCE && dist < minDist) {
                    minDist = dist;
                    activeNote = n;
                }
            });

            if (!activeNote) return; // Whiff

            const page = activeNote.val;
            const memVal = state.memory[frameIdx];
            let success = false;
            let type = '';

            // A. PAGE IN MEMORY (HIT)
            if (state.memory.includes(page)) {
                if (memVal === page) {
                    success = true;
                    type = 'HIT';
                    if (state.algo === 'LRU') state.meta[frameIdx] = Date.now();
                }
            } 
            // B. NOT IN MEMORY (LOAD/REPLACE)
            else {
                if (state.memory.includes(null)) {
                    if (memVal === null) {
                        success = true;
                        type = 'LOAD';
                        state.memory[frameIdx] = page;
                        if (state.algo !== 'OPT') state.meta[frameIdx] = Date.now();
                    }
                } else {
                    if (checkVictim(frameIdx)) {
                        success = true;
                        type = 'REPLACE';
                        state.memory[frameIdx] = page;
                        if (state.algo !== 'OPT') state.meta[frameIdx] = Date.now();
                    }
                }
            }

            if (success) {
                if (type === 'HIT') playSound('hit');
                if (type === 'LOAD') playSound('load');
                if (type === 'REPLACE') playSound('replace');

                showFeedback("EXCELLENT!", "text-neon-green");
                activeNote.missed = true;
                
                // Explode
                activeNote.el.style.transform = "scale(1.5)";
                activeNote.el.style.opacity = "0";
                setTimeout(() => activeNote.el.remove(), 200);

                state.score += (100 * state.combo);
                state.combo = Math.min(8, state.combo + 1);
            } else {
                // SUDDEN DEATH
                playSound('error');
                showFeedback("ERROR!", "text-neon-red");
                state.combo = 1;
                state.score = Math.max(0, state.score - 50);
                
                activeNote.missed = true;
                activeNote.el.classList.add('bg-neon-red', 'border-neon-red');
                activeNote.el.style.transform = "scale(0.8) rotate(20deg)";
                activeNote.el.style.opacity = "0";
                setTimeout(() => activeNote.el.remove(), 200);
            }
            updateHUD();
            updateFrames();
        }

        function checkVictim(idx) {
            if (state.algo === 'FIFO' || state.algo === 'LRU') {
                let min = Infinity; 
                let v = -1;
                state.meta.forEach((val, i) => { if (val < min) { min = val; v = i; } });
                return idx === v;
            }
            if (state.algo === 'OPT') {
                let maxDist = -1;
                let v = -1;
                state.memory.forEach((memPage, i) => {
                    let dist = state.queue.indexOf(memPage);
                    if (dist === -1) dist = 9999;
                    if (dist > maxDist) { maxDist = dist; v = i; }
                });
                return idx === v;
            }
            return false;
        }

        function handleMiss(note) {
            playSound('error');
            showFeedback("MISS", "text-gray-500");
            state.combo = 1;
            state.score = Math.max(0, state.score - 50);
            updateHUD();
            note.el.style.opacity = 0.5;
            note.el.style.filter = "grayscale(100%)";
        }

        // --- UI ---
        function updateHUD() {
            document.getElementById('hudScore').innerText = state.score.toString().padStart(6, '0');
            document.getElementById('hudCombo').innerText = `x${state.combo}`;
        }

        function updateFrames() {
            state.memory.forEach((val, i) => {
                const elVal = document.getElementById(`val-${i}`);
                const elBar = document.getElementById(`bar-${i}`);
                elVal.innerText = val !== null ? val : "--";
                
                let h = 0;
                if (val !== null && state.algo !== 'OPT') {
                    const age = Date.now() - state.meta[i];
                    h = Math.min(100, age / 5000 * 100);
                }
                elBar.style.height = `${h}%`;
                // Color Danger
                elBar.style.backgroundColor = h > 80 ? '#ff0033' : '#334155';
            });
        }

        function updateQueueVis() {
            const list = document.getElementById('queueList');
            list.innerHTML = state.queue.slice(0, 5).map(v => `<div class="bg-gray-800 text-white px-2 py-1 rounded border border-gray-600 font-arcade text-xs">${v}</div>`).join('');
        }

        function showFeedback(txt, colorClass) {
            const el = document.getElementById('feedbackText');
            el.innerText = txt;
            el.className = `h-12 text-5xl font-arcade drop-shadow-[0_0_20px_rgba(255,255,255,0.8)] transition-all scale-125 italic ${colorClass}`;
            setTimeout(() => {
                el.classList.remove('scale-125');
                el.classList.add('scale-0');
            }, 500);
        }

        function endGame() {
            state.active = false;
            playSound('over');
            document.getElementById('screenOver').classList.remove('hidden');
            document.getElementById('finalScore').innerText = state.score;
        }

        updateMenuSelection();
    </script>
</body>
</html>
