<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemHero EXPROM 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#050011',
                        'panel': '#0f172a',
                        'neon-cyan': '#00f3ff',
                        'neon-pink': '#ff00ff',
                        'neon-yellow': '#ffe600',
                        'neon-green': '#00ff66',
                        'neon-red': '#ff0033',
                    },
                    fontFamily: {
                        arcade: ['"Press Start 2P"', 'cursive'],
                        cyber: ['"Orbitron"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050011;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        /* --- BACKGROUND FX --- */
        .retro-grid {
            position: fixed;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background-image: 
                linear-gradient(rgba(180, 0, 255, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(180, 0, 255, 0.3) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg) translateY(0);
            animation: gridMove 4s linear infinite;
            z-index: -1;
            box-shadow: 0 0 100px rgba(180, 0, 255, 0.2);
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(60px); }
        }

        .horizon-glow {
            position: fixed;
            top: 40%;
            left: 0; right: 0;
            height: 200px;
            background: linear-gradient(to top, rgba(0, 243, 255, 0.1), transparent);
            pointer-events: none;
            z-index: -1;
        }

        /* --- UI ELEMENTS --- */
        .glass-panel {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .menu-btn {
            position: relative;
            transition: all 0.2s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        
        .menu-btn.selected {
            background: #fff !important;
            color: #000 !important;
            transform: scale(1.05);
            box-shadow: 0 0 20px #fff;
        }

        .note {
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
            box-shadow: 0 0 15px currentColor;
            z-index: 10;
        }

        .key-hint {
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            background: rgba(0,0,0,0.5);
        }

        /* Hit Zone & Highway */
        .highway-track {
            transform: rotateX(40deg);
            transform-origin: 50% 100%;
            height: 120%;
            background: linear-gradient(180deg, #020617 0%, #1e293b 100%);
            border-left: 4px solid #334155;
            border-right: 4px solid #334155;
            position: relative;
            top: -20%;
        }

        .hit-zone-line {
            height: 4px;
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 5px white;
            position: absolute;
            left: 0; right: 0;
            bottom: 200px; /* Exact collision point */
            transition: all 0.1s;
        }
        
        .hit-zone-line.active {
            background: #fff;
            box-shadow: 0 0 20px #00f3ff;
            height: 6px;
        }
    </style>
</head>
<body class="h-screen flex flex-col font-cyber">

    <!-- Background -->
    <div class="retro-grid"></div>
    <div class="horizon-glow"></div>

    <!-- AUDIO TOGGLE -->
    <button id="btnAudio" onclick="toggleAudio()" class="absolute top-4 right-4 z-50 text-xs text-gray-500 hover:text-white font-arcade border border-gray-700 p-2 bg-black hover:border-white transition">
        [M] SONIDO: OFF
    </button>

    <!-- 1. MAIN MENU -->
    <div id="screenMenu" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6">
        <h1 class="text-6xl md:text-8xl font-arcade text-transparent bg-clip-text bg-gradient-to-b from-white to-neon-cyan mb-4 animate-float drop-shadow-[0_0_15px_rgba(0,243,255,0.5)] text-center">
            MEM_HERO
        </h1>
        <p class="text-neon-pink font-arcade text-xs tracking-widest uppercase mb-12 animate-pulse">EXPROM 2025 Edition</p>
        
        <div class="flex flex-col gap-4 w-full max-w-md" id="menuList">
            <div class="menu-item menu-btn bg-gray-900 border-l-4 border-neon-yellow p-6 text-center cursor-pointer" data-algo="FIFO">
                <h3 class="text-2xl font-bold text-neon-yellow font-arcade">FIFO</h3>
                <p class="text-gray-400 text-xs mt-2">Dificultad: FÁCIL</p>
            </div>
            
            <div class="menu-item menu-btn bg-gray-900 border-l-4 border-neon-cyan p-6 text-center cursor-pointer" data-algo="LRU">
                <h3 class="text-2xl font-bold text-neon-cyan font-arcade">LRU</h3>
                <p class="text-gray-400 text-xs mt-2">Dificultad: MEDIA</p>
            </div>

            <div class="menu-item menu-btn bg-gray-900 border-l-4 border-neon-pink p-6 text-center cursor-pointer" data-algo="OPT">
                <h3 class="text-2xl font-bold text-neon-pink font-arcade">OPT</h3>
                <p class="text-gray-400 text-xs mt-2">Dificultad: DIFÍCIL</p>
            </div>
        </div>
        
        <div class="mt-12 text-gray-500 text-[10px] font-arcade text-center opacity-70">
            <span class="text-white">CONTROLES MENÚ:</span> FLECHAS ↑ ↓ & ENTER<br><br>
            <span class="text-white">JUEGO:</span> 1, 2, 3 ó A, S, D
        </div>
    </div>

    <!-- 2. BRIEFING -->
    <div id="screenBriefing" class="hidden absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center p-6 backdrop-blur-md">
        <div class="glass-panel max-w-2xl w-full p-8 rounded-xl relative border-t-4" id="briefCard">
            <h2 id="briefTitle" class="text-5xl font-arcade mb-6 text-white drop-shadow-md">ALGORITMO</h2>
            
            <div class="space-y-6 font-cyber text-lg">
                <p id="briefDesc" class="text-gray-300 leading-relaxed border-l-2 border-white pl-4">...</p>
                <div class="bg-white/5 p-4 rounded">
                    <h4 class="text-neon-green text-sm uppercase font-bold mb-2">ESTRATEGIA GANADORA</h4>
                    <p id="briefStrat" class="text-white">...</p>
                </div>
                <div class="text-xs text-neon-red font-mono mt-4">
                    ⚠️ ADVERTENCIA: La velocidad aumentará con el tiempo. Un error destruye la página.
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-between items-center">
                <div class="text-xs text-gray-500 font-arcade">PRESIONA [ENTER] PARA INICIAR</div>
                <button onclick="startGame()" class="bg-white text-black font-arcade py-3 px-8 hover:bg-neon-cyan transition shadow-glow">GO!</button>
            </div>
        </div>
    </div>

    <!-- 3. GAME HUD -->
    <div id="gameHUD" class="hidden absolute top-0 left-0 right-0 p-4 flex justify-between items-start z-40 pointer-events-none">
        <div class="glass-panel px-4 py-2 rounded-br-xl">
            <div class="text-[10px] text-gray-400 uppercase font-arcade">Algoritmo</div>
            <div id="hudAlgo" class="text-xl font-bold text-white">--</div>
        </div>

        <div class="flex flex-col items-center">
             <div id="feedbackText" class="h-8 text-3xl font-arcade text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.8)] transition-transform scale-0"></div>
             <div class="text-4xl font-arcade text-neon-yellow mt-2 drop-shadow-md" id="hudScore">0000</div>
             <div class="text-[10px] text-neon-red font-arcade animate-pulse mt-1" id="speedIndicator">SPEED: 100%</div>
        </div>

        <div class="glass-panel px-4 py-2 rounded-bl-xl text-right">
             <div class="text-[10px] text-gray-400 uppercase font-arcade">Combo</div>
             <div id="hudCombo" class="text-xl font-bold text-neon-green">x1</div>
        </div>
    </div>

    <!-- 4. GAME AREA -->
    <div id="screenGame" class="hidden flex-1 relative flex flex-col h-full">
        
        <!-- HIGHWAY -->
        <div class="highway-container flex-1 bg-void relative">
            <div class="highway-track mx-auto w-full max-w-3xl">
                <!-- Grid Lines Animation -->
                <div class="absolute inset-0 bg-[linear-gradient(0deg,transparent_24%,rgba(59,130,246,.1)_25%,rgba(59,130,246,.1)_26%,transparent_27%,transparent_74%,rgba(59,130,246,.1)_75%,rgba(59,130,246,.1)_76%,transparent_77%,transparent)] bg-[length:50px_50px] animate-[scrollGrid_1s_linear_infinite]"></div>
                
                <!-- HIT ZONE VISUAL (Corrected Position) -->
                <div id="visualHitLine" class="hit-zone-line"></div>
                <div class="absolute bottom-[205px] left-2 text-[10px] text-gray-500 font-arcade opacity-50">TARGET LINE</div>

                <!-- NOTES LAYER -->
                <div id="layerNotes" class="absolute inset-0 pointer-events-none"></div>
            </div>

            <!-- Queue Preview -->
            <div class="absolute top-20 right-4 w-32 hidden md:block opacity-50">
                <div class="text-[10px] text-neon-cyan mb-2 font-arcade text-right">NEXT:</div>
                <div id="queueList" class="flex flex-col gap-2 items-end"></div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="h-40 bg-black/90 border-t border-white/20 z-40 flex justify-center items-center gap-4 p-4 pb-8">
            
            <!-- FRAME 0 -->
            <div id="btn-0" class="relative w-32 h-32 bg-gray-900 border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center group transition-transform duration-75">
                <div class="absolute top-2 right-2 flex gap-1"><span class="key-hint">1</span><span class="key-hint">A</span></div>
                <div class="text-[10px] text-gray-500 font-arcade mb-1">MARCO 0</div>
                <div id="val-0" class="text-4xl font-arcade text-white z-10">--</div>
                <div id="bar-0" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all duration-300"></div>
            </div>

            <!-- FRAME 1 -->
            <div id="btn-1" class="relative w-32 h-32 bg-gray-900 border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center group transition-transform duration-75">
                <div class="absolute top-2 right-2 flex gap-1"><span class="key-hint">2</span><span class="key-hint">S</span></div>
                <div class="text-[10px] text-gray-500 font-arcade mb-1">MARCO 1</div>
                <div id="val-1" class="text-4xl font-arcade text-white z-10">--</div>
                <div id="bar-1" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all duration-300"></div>
            </div>

            <!-- FRAME 2 -->
            <div id="btn-2" class="relative w-32 h-32 bg-gray-900 border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center group transition-transform duration-75">
                <div class="absolute top-2 right-2 flex gap-1"><span class="key-hint">3</span><span class="key-hint">D</span></div>
                <div class="text-[10px] text-gray-500 font-arcade mb-1">MARCO 2</div>
                <div id="val-2" class="text-4xl font-arcade text-white z-10">--</div>
                <div id="bar-2" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all duration-300"></div>
            </div>

        </div>
    </div>

    <!-- 5. GAME OVER (UPDATED) -->
    <div id="screenOver" class="hidden absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center">
        <h2 class="text-5xl text-neon-red font-arcade mb-6 animate-pulse text-center leading-tight">SYSTEM<br>FAILURE</h2>
        <div class="glass-panel p-10 rounded-xl text-center border border-neon-red w-full max-w-md">
            <p class="text-gray-400 font-arcade text-[10px] uppercase mb-2">Puntuación Final</p>
            <p id="finalScore" class="text-6xl text-white font-arcade mb-8 drop-shadow-glow">0</p>
            
            <div class="flex flex-col gap-4">
                <button onclick="restartGame()" class="bg-white text-black py-4 font-bold uppercase hover:bg-neon-green hover:text-white transition font-arcade text-xs shadow-[0_0_15px_rgba(255,255,255,0.4)]">
                    ↻ REINTENTAR
                </button>
                <button onclick="goToMenu()" class="bg-transparent border-2 border-gray-600 text-gray-300 py-4 font-bold uppercase hover:border-white hover:text-white transition font-arcade text-xs">
                    ← VOLVER AL MENÚ
                </button>
            </div>
        </div>
    </div>

    <!-- --- JAVASCRIPT ENGINE --- -->
    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = false;

        function toggleAudio() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('btnAudio');
            if (soundEnabled) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                btn.innerText = "[M] SONIDO: ON";
                btn.classList.add('text-neon-green', 'border-neon-green');
                btn.classList.remove('border-gray-700');
                playSound('select');
            } else {
                btn.innerText = "[M] SONIDO: OFF";
                btn.classList.remove('text-neon-green', 'border-neon-green');
                btn.classList.add('border-gray-700');
            }
        }

        const sounds = {
            select: { freq: 440, type: 'square', dur: 0.1 },
            move: { freq: 220, type: 'sawtooth', dur: 0.05 },
            hit: { freq: 880, type: 'sine', dur: 0.1, slide: 1200 },
            load: { freq: 600, type: 'square', dur: 0.15 },
            replace: { freq: 400, type: 'sawtooth', dur: 0.2 },
            error: { freq: 100, type: 'sawtooth', dur: 0.3, slide: 50 },
            over: { freq: 150, type: 'sawtooth', dur: 1.0, slide: 20 }
        };

        function playSound(name) {
            if (!soundEnabled) return;
            const s = sounds[name];
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = s.type;
            osc.frequency.setValueAtTime(s.freq, audioCtx.currentTime);
            if (s.slide) osc.frequency.exponentialRampToValueAtTime(s.slide, audioCtx.currentTime + s.dur);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + s.dur);
        }

        // --- GAME ENGINE ---
        // IMPORTANT: The target line is set at bottom: 200px in CSS.
        // We need to calculate its position relative to the highway top.
        const BASE_SPEED = 150; 
        const MAX_SPEED = 600;
        const HIT_TOLERANCE = 50; // pixels up/down

        let state = {
            screen: 'MENU', 
            algo: 'FIFO',
            selectedMenuIdx: 0,
            active: false,
            score: 0,
            combo: 1,
            memory: [null, null, null],
            meta: [0, 0, 0],
            queue: [],
            notes: [],
            lastTime: 0,
            spawnTimer: 0,
            idCounter: 0,
            currentSpeed: BASE_SPEED
        };

        // --- MENU LOGIC ---
        const menuItems = document.querySelectorAll('.menu-item');
        
        function updateMenuSelection() {
            menuItems.forEach((el, idx) => {
                if (idx === state.selectedMenuIdx) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function handleMenuInput(key) {
            if (key === 'ArrowDown' || key === 's') {
                state.selectedMenuIdx = (state.selectedMenuIdx + 1) % menuItems.length;
                playSound('move');
                updateMenuSelection();
            } else if (key === 'ArrowUp' || key === 'w') {
                state.selectedMenuIdx = (state.selectedMenuIdx - 1 + menuItems.length) % menuItems.length;
                playSound('move');
                updateMenuSelection();
            } else if (key === 'Enter') {
                const algo = menuItems[state.selectedMenuIdx].getAttribute('data-algo');
                playSound('select');
                prepareBriefing(algo);
            }
        }

        // --- BRIEFING LOGIC ---
        function prepareBriefing(algo) {
            state.screen = 'BRIEF';
            state.algo = algo;
            document.getElementById('screenMenu').classList.add('hidden');
            document.getElementById('screenBriefing').classList.remove('hidden');
            
            const title = document.getElementById('briefTitle');
            const desc = document.getElementById('briefDesc');
            const strat = document.getElementById('briefStrat');
            const card = document.getElementById('briefCard');

            title.innerText = algo;
            
            if (algo === 'FIFO') {
                title.className = "text-5xl font-arcade mb-6 text-neon-yellow drop-shadow-md";
                card.style.borderColor = '#ffe600';
                desc.innerText = "First-In, First-Out. La víctima es la MÁS VIEJA (la que llegó primero).";
                strat.innerText = "Reemplaza la barra roja MÁS LLENA.";
            } else if (algo === 'LRU') {
                title.className = "text-5xl font-arcade mb-6 text-neon-cyan drop-shadow-md";
                card.style.borderColor = '#00f3ff';
                desc.innerText = "Least Recently Used. La víctima es la que hace MÁS TIEMPO que no se usa.";
                strat.innerText = "HIT = Refresco. Reemplaza la barra roja MÁS LLENA.";
            } else {
                title.className = "text-5xl font-arcade mb-6 text-neon-pink drop-shadow-md";
                card.style.borderColor = '#ff00ff';
                desc.innerText = "Optimal. Mira al futuro. La víctima es la que tardará MÁS TIEMPO en volver.";
                strat.innerText = "Mira la lista 'NEXT'. Elimina la que NO esté o esté AL FINAL.";
            }
        }

        // --- NAVIGATION FUNCTIONS ---
        function startGame() {
            playSound('select');
            state.screen = 'GAME';
            document.getElementById('screenBriefing').classList.add('hidden');
            document.getElementById('screenOver').classList.add('hidden');
            document.getElementById('gameHUD').classList.remove('hidden');
            document.getElementById('screenGame').classList.remove('hidden');
            
            document.getElementById('hudAlgo').innerText = state.algo;
            let color = state.algo === 'FIFO' ? 'text-neon-yellow' : (state.algo === 'LRU' ? 'text-neon-cyan' : 'text-neon-pink');
            document.getElementById('hudAlgo').className = `text-xl font-bold font-tech ${color}`;

            resetState();
            generateQueue();
            state.active = true;
            state.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function restartGame() {
            playSound('select');
            state.screen = 'GAME';
            document.getElementById('screenOver').classList.add('hidden');
            resetState();
            generateQueue();
            state.active = true;
            state.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function goToMenu() {
            playSound('select');
            state.screen = 'MENU';
            document.getElementById('screenOver').classList.add('hidden');
            document.getElementById('screenGame').classList.add('hidden');
            document.getElementById('gameHUD').classList.add('hidden');
            document.getElementById('screenMenu').classList.remove('hidden');
            resetState();
            updateMenuSelection();
        }

        function resetState() {
            state.score = 0;
            state.combo = 1;
            state.memory = [null, null, null];
            state.meta = [0, 0, 0];
            state.queue = [];
            state.notes = [];
            state.spawnTimer = 0;
            state.currentSpeed = BASE_SPEED;
            
            document.getElementById('layerNotes').innerHTML = '';
            updateHUD();
            updateFrames();
        }

        // --- INPUT GLOBAL LISTENER ---
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'm') toggleAudio();

            if (state.screen === 'MENU') {
                handleMenuInput(e.key);
                return;
            }
            if (state.screen === 'BRIEF') {
                if (e.key === 'Enter') startGame();
                return;
            }
            if (state.screen === 'GAME') {
                const key = e.key.toLowerCase();
                const map = { 
                    '1': 0, 'a': 0,
                    '2': 1, 's': 1,
                    '3': 2, 'd': 2
                };
                if (map.hasOwnProperty(key)) {
                    handleGameInput(map[key]);
                    const btn = document.getElementById(`btn-${map[key]}`);
                    btn.classList.add('border-white', 'scale-95'); 
                    setTimeout(() => btn.classList.remove('border-white', 'scale-95'), 100);
                }
            }
        });

        // --- GAME LOOP ---
        function generateQueue() {
            state.queue = [];
            for(let i=0; i<100; i++) {
                if (i>3 && Math.random() < 0.5) state.queue.push(state.queue[i-1] || 0);
                else state.queue.push(Math.floor(Math.random() * 8));
            }
            updateQueueVis();
        }

        function gameLoop(timestamp) {
            if (!state.active) return;
            const dt = (timestamp - state.lastTime) / 1000;
            state.lastTime = timestamp;
            updateGame(dt);
            requestAnimationFrame(gameLoop);
        }

        function updateGame(dt) {
            // PROGRESSIVE SPEED: Increase speed by 5 pixels/sec every second
            if (state.currentSpeed < MAX_SPEED) {
                state.currentSpeed += (dt * 5); 
            }
            // Update Speed Indicator
            const speedPct = Math.round((state.currentSpeed / BASE_SPEED) * 100);
            document.getElementById('speedIndicator').innerText = `SPEED: ${speedPct}%`;

            // Spawn
            state.spawnTimer -= dt;
            if (state.spawnTimer <= 0 && state.queue.length > 0) {
                spawnNote();
                // Spawn rate gets faster as speed increases
                const rate = Math.max(0.5, 2.0 - ((state.currentSpeed - BASE_SPEED) / 500)); 
                state.spawnTimer = rate; 
            }

            // Move Notes
            // We use the Highway container height to know where to draw.
            // But logic uses pixel distance from top (0) to bottom.
            const highway = document.getElementById('screenGame'); // roughly entire screen
            const containerH = highway.clientHeight - 160; // Highway height excluding controls
            
            // Visual Target: Bottom: 200px (CSS).
            // In Top coords: containerH - 40 approx? No, let's use calculated:
            const targetY = containerH - 40; // This visually aligns with the CSS bottom:200px line

            // Check Collision for visual glow
            let activeInZone = false;

            state.notes.forEach(note => {
                note.y += state.currentSpeed * dt;
                note.el.style.top = `${note.y}px`;

                // Calculate distance to target line
                const dist = Math.abs((note.y + 30) - targetY); // +30 is note center
                if (dist < HIT_TOLERANCE && !note.missed) activeInZone = true;

                // Miss Logic (Passes too far)
                if (!note.missed && note.y > targetY + HIT_TOLERANCE + 20) {
                    note.missed = true;
                    handleMiss(note);
                }
            });

            // Pulse the line
            const line = document.getElementById('visualHitLine');
            if (activeInZone) line.classList.add('active');
            else line.classList.remove('active');

            // Cleanup
            state.notes = state.notes.filter(n => n.y < containerH + 200);

            if (state.queue.length === 0 && state.notes.length === 0) endGame();
        }

        function spawnNote() {
            const val = state.queue.shift();
            updateQueueVis();
            
            const el = document.createElement('div');
            let color = state.algo === 'FIFO' ? 'bg-neon-yellow border-neon-yellow text-black' : 
                        (state.algo === 'LRU' ? 'bg-neon-cyan border-neon-cyan text-black' : 'bg-neon-pink border-neon-pink text-black');
            
            el.className = `note absolute border-2 font-bold flex items-center justify-center text-xl ${color}`;
            el.style.width = '60px';
            el.style.height = '60px';
            el.innerText = val;
            el.style.top = '-60px'; 
            document.getElementById('layerNotes').appendChild(el);

            state.notes.push({
                id: state.idCounter++,
                val: val,
                y: -60,
                el: el,
                missed: false
            });
        }

        function handleGameInput(frameIdx) {
            // Define Hit Line Position (Logic)
            // Highway is flex-1. Controls are h-40 (160px).
            // Line is bottom: 200px (CSS).
            // So distance from top of notes layer to line is: (ContainerH - 160) - (200 - 160) ? No.
            // CSS bottom: 200px relates to the highway container.
            // Notes use absolute top within highway.
            // Highway height = X. Line is at Y = X - 200.
            const highway = document.querySelector('.highway-track');
            const highwayRect = highway.getBoundingClientRect();
            // The hit line element
            const line = document.getElementById('visualHitLine');
            const lineRect = line.getBoundingClientRect();
            
            // Calculate Note positions relative to viewport to match line rect
            let activeNote = null;
            let minDist = Infinity;

            state.notes.forEach(n => {
                if (n.missed) return;
                const noteRect = n.el.getBoundingClientRect();
                const noteCenter = noteRect.top + (noteRect.height / 2);
                const lineCenter = lineRect.top + (lineRect.height / 2);
                
                const dist = Math.abs(noteCenter - lineCenter);

                if (dist < HIT_TOLERANCE && dist < minDist) {
                    minDist = dist;
                    activeNote = n;
                }
            });

            if (!activeNote) return; // Whiff

            // LOGIC CHECK
            const page = activeNote.val;
            const memVal = state.memory[frameIdx];
            let success = false;
            let type = '';

            // A. PAGE IN MEMORY?
            if (state.memory.includes(page)) {
                if (memVal === page) {
                    success = true;
                    type = 'HIT';
                    if (state.algo === 'LRU') state.meta[frameIdx] = Date.now();
                }
            } 
            // B. NOT IN MEMORY -> LOAD OR REPLACE
            else {
                if (state.memory.includes(null)) {
                    if (memVal === null) {
                        success = true;
                        type = 'LOAD';
                        state.memory[frameIdx] = page;
                        if (state.algo !== 'OPT') state.meta[frameIdx] = Date.now();
                    }
                } else {
                    if (checkVictim(frameIdx)) {
                        success = true;
                        type = 'REPLACE';
                        state.memory[frameIdx] = page;
                        if (state.algo !== 'OPT') state.meta[frameIdx] = Date.now();
                    }
                }
            }

            if (success) {
                if (type === 'HIT') playSound('hit');
                if (type === 'LOAD') playSound('load');
                if (type === 'REPLACE') playSound('replace');

                showFeedback("GOOD!", "text-neon-green");
                activeNote.missed = true;
                
                // Explode animation
                activeNote.el.style.transform = "scale(1.5)";
                activeNote.el.style.opacity = "0";
                setTimeout(() => activeNote.el.remove(), 200);

                state.score += (100 * state.combo);
                state.combo = Math.min(8, state.combo + 1);
            } else {
                // FAILURE = DESTROY NOTE (Sudden Death for that note)
                playSound('error');
                showFeedback("MISS", "text-neon-red");
                state.combo = 1;
                state.score = Math.max(0, state.score - 50);
                
                // NEW: Fail immediately destroys note
                activeNote.missed = true;
                activeNote.el.classList.add('bg-neon-red', 'border-neon-red');
                activeNote.el.style.transform = "scale(0.8) rotate(20deg)";
                activeNote.el.style.opacity = "0";
                setTimeout(() => activeNote.el.remove(), 200);
            }
            updateHUD();
            updateFrames();
        }

        function checkVictim(idx) {
            if (state.algo === 'FIFO' || state.algo === 'LRU') {
                let min = Infinity; 
                let v = -1;
                state.meta.forEach((val, i) => { if (val < min) { min = val; v = i; } });
                return idx === v;
            }
            if (state.algo === 'OPT') {
                let maxDist = -1;
                let v = -1;
                state.memory.forEach((memPage, i) => {
                    let dist = state.queue.indexOf(memPage);
                    if (dist === -1) dist = 9999;
                    if (dist > maxDist) { maxDist = dist; v = i; }
                });
                return idx === v;
            }
            return false;
        }

        function handleMiss(note) {
            playSound('error');
            showFeedback("LOST", "text-gray-500");
            state.combo = 1;
            state.score = Math.max(0, state.score - 50);
            updateHUD();
            note.el.style.opacity = 0.5;
            note.el.style.backgroundColor = '#333';
        }

        // --- UI UPDATES ---
        function updateHUD() {
            document.getElementById('hudScore').innerText = state.score.toString().padStart(6, '0');
            document.getElementById('hudCombo').innerText = `x${state.combo}`;
        }

        function updateFrames() {
            state.memory.forEach((val, i) => {
                const elVal = document.getElementById(`val-${i}`);
                const elBar = document.getElementById(`bar-${i}`);
                
                elVal.innerText = val !== null ? val : "--";
                
                let h = 0;
                if (val !== null && state.algo !== 'OPT') {
                    const age = Date.now() - state.meta[i];
                    h = Math.min(100, age / 5000 * 100);
                }
                elBar.style.height = `${h}%`;
                elBar.style.backgroundColor = h > 80 ? '#ff0033' : '#334155';
            });
        }

        function updateQueueVis() {
            const list = document.getElementById('queueList');
            list.innerHTML = state.queue.slice(0, 5).map(v => `<div class="bg-gray-800 text-white px-2 py-1 rounded border border-gray-600 font-arcade text-xs">${v}</div>`).join('');
        }

        function showFeedback(txt, colorClass) {
            const el = document.getElementById('feedbackText');
            el.innerText = txt;
            el.className = `h-8 text-3xl font-arcade drop-shadow-[0_0_10px_rgba(255,255,255,0.8)] transition-all scale-125 ${colorClass}`;
            setTimeout(() => {
                el.classList.remove('scale-125');
                el.classList.add('scale-0');
            }, 500);
        }

        function endGame() {
            state.active = false;
            playSound('over');
            document.getElementById('screenOver').classList.remove('hidden');
            document.getElementById('finalScore').innerText = state.score;
        }

        // Init Menu Selection
        updateMenuSelection();
    </script>
</body>
</html>
