<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MemHero: EXPROM 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#050011',
                        'panel': '#0f172a',
                        'neon-cyan': '#00f3ff',
                        'neon-pink': '#ff00ff',
                        'neon-yellow': '#ffe600',
                        'neon-green': '#00ff66',
                        'neon-red': '#ff0033',
                    },
                    fontFamily: {
                        arcade: ['"Press Start 2P"', 'cursive'],
                        cyber: ['"Orbitron"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        sunGlow: {
                            'from': { boxShadow: '0 0 40px #ff00ff, 0 0 80px #ff00ff inset' },
                            'to': { boxShadow: '0 0 60px #ff00ff, 0 0 100px #ff00ff inset' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020005;
            color: #fff;
            overflow: hidden;
            user-select: none;
            touch-action: none;
            font-family: 'Orbitron', sans-serif;
        }

        .hidden { display: none !important; }

        /* --- BACKGROUND FX --- */
        .world-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            perspective: 1000px;
            overflow: hidden;
            z-index: -1;
            background: linear-gradient(to bottom, #120024 0%, #000000 100%);
        }

        .retro-sun {
            position: absolute;
            top: 10%; left: 50%; transform: translateX(-50%);
            width: 300px; height: 300px; border-radius: 50%;
            background: linear-gradient(to bottom, #ffe600 0%, #ff00ff 50%, #7000ff 100%);
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.6);
            z-index: 0;
        }

        .cyber-grid {
            position: absolute;
            bottom: -50%; left: -50%; width: 200%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.4) 2px, transparent 2px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.4) 2px, transparent 2px);
            background-size: 80px 80px;
            transform: rotateX(70deg);
            transform-origin: 50% 0;
            animation: gridScroll 3s linear infinite;
            z-index: 1;
        }

        @keyframes gridScroll {
            0% { background-position: 0 0; }
            100% { background-position: 0 80px; }
        }

        /* --- UI ELEMENTS --- */
        .glass-panel {
            background: rgba(10, 10, 25, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 40px rgba(0,0,0,0.9);
        }

        .menu-btn {
            position: relative;
            transition: all 0.1s;
            min-height: 80px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent; 
        }
        
        .menu-btn:active {
            transform: scale(0.98);
            background-color: rgba(255,255,255,0.1);
        }

        .menu-btn.selected {
            background: #fff !important;
            color: #000 !important;
            box-shadow: 0 0 25px rgba(255,255,255,0.8);
            z-index: 10;
            transform: scale(1.05);
        }
        
        .menu-btn.selected h3 { color: #000 !important; }
        .menu-btn.selected p { color: #333 !important; }

        /* FIXED NOTE CENTERING */
        .note {
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            box-shadow: 0 0 15px currentColor;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 4px; /* Optical center fix for Arcade Font */
        }

        .key-hint {
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            background: rgba(0,0,0,0.5);
        }

        .hit-zone-line {
            height: 4px;
            background: rgba(255,255,255,0.6);
            box-shadow: 0 0 15px white, 0 0 30px #00f3ff;
            position: absolute;
            left: 0; right: 0;
            bottom: 200px;
            transition: all 0.1s;
        }
        
        .hit-zone-line.active {
            background: #fff;
            height: 6px;
            box-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
        }

        .progress-container {
            width: 100%; height: 6px; background: #1e293b;
            position: absolute; top: 0; left: 0; z-index: 100;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #00f3ff, #ff00ff);
            width: 0%; transition: width 0.5s ease;
        }

        .control-pad {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="h-screen flex flex-col font-cyber">

    <div class="world-container">
        <div class="retro-sun"></div>
        <div class="cyber-grid"></div>
        <div style="position: absolute; bottom: 30%; left:0; width:100%; height:2px; background:#00f3ff; box-shadow:0 0 20px #00f3ff; z-index:2;"></div>
    </div>

    <!-- GLOBAL CONTROLS -->
    <div class="absolute top-4 right-4 z-[60] flex gap-2">
        <button id="btnPauseTop" class="hidden text-[10px] md:text-xs text-gray-400 hover:text-white font-arcade border border-gray-700 bg-black/80 p-2 hover:border-white transition backdrop-blur-sm cursor-pointer" onclick="togglePause()">
            [P] PAUSA
        </button>
        <button id="btnAudio" class="text-[10px] md:text-xs text-gray-400 hover:text-white font-arcade border border-gray-700 bg-black/80 p-2 hover:border-white transition backdrop-blur-sm cursor-pointer" onclick="toggleAudio()">
            [M] SONIDO: OFF
        </button>
    </div>

    <!-- SCREEN 1: MENU -->
    <div id="screenMenu" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black/40 backdrop-blur-sm">
        <div class="relative z-10 animate-float mt-8">
            <h1 class="text-5xl md:text-8xl font-arcade text-transparent bg-clip-text bg-gradient-to-b from-white via-neon-cyan to-neon-pink mb-2 drop-shadow-[0_0_25px_rgba(0,243,255,0.6)] text-center tracking-tighter leading-tight">
                MEM_HERO
            </h1>
            <div class="bg-black/90 text-neon-yellow font-arcade text-[10px] md:text-sm tracking-[0.3em] uppercase px-4 py-2 border border-neon-yellow inline-block absolute -bottom-6 left-1/2 transform -translate-x-1/2 shadow-[0_0_15px_rgba(255,230,0,0.5)] whitespace-nowrap">
                EXPROM 2025
            </div>
        </div>

        <div class="flex flex-col gap-4 w-full max-w-md mt-16 z-20">
            <div class="menu-item menu-btn bg-black/90 border-l-4 border-neon-yellow p-4 cursor-pointer" onclick="prepareBriefing('FIFO')" data-algo="FIFO">
                <h3 class="text-xl font-bold text-neon-yellow font-arcade">FIFO</h3>
                <p class="text-gray-400 text-xs mt-1 font-mono">Dificultad: F√ÅCIL</p>
            </div>
            
            <div class="menu-item menu-btn bg-black/90 border-l-4 border-neon-cyan p-4 cursor-pointer" onclick="prepareBriefing('LRU')" data-algo="LRU">
                <h3 class="text-xl font-bold text-neon-cyan font-arcade">LRU</h3>
                <p class="text-gray-400 text-xs mt-1 font-mono">Dificultad: MEDIA</p>
            </div>

            <div class="menu-item menu-btn bg-black/90 border-l-4 border-neon-pink p-4 cursor-pointer" onclick="prepareBriefing('OPT')" data-algo="OPT">
                <h3 class="text-xl font-bold text-neon-pink font-arcade">OPT</h3>
                <p class="text-gray-400 text-xs mt-1 font-mono">Dificultad: DIF√çCIL</p>
            </div>
        </div>
        
        <div class="mt-8 text-gray-500 text-[10px] font-arcade text-center opacity-80 bg-black/80 p-3 rounded border border-gray-800">
            CONTROLES: T√ÅCTIL O TECLADO (1-2-3 / A-S-D)
        </div>
    </div>

    <!-- SCREEN 2: BRIEFING -->
    <div id="screenBriefing" class="hidden absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg p-6 rounded-xl border-t-4 border-white flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6">
                <h2 id="briefTitle" class="text-4xl font-arcade text-white drop-shadow-md">MODO</h2>
                <button onclick="goToMenu()" class="text-gray-400 hover:text-white border border-gray-600 px-3 py-1 text-xs font-arcade bg-black/50">
                    X SALIR (ESC)
                </button>
            </div>
            <div class="space-y-6 overflow-y-auto flex-1 font-cyber text-sm md:text-base">
                <p id="briefDesc" class="text-gray-300 leading-relaxed border-l-4 border-white pl-4">...</p>
                <div class="bg-white/10 p-4 rounded border-l-4 border-neon-green">
                    <h4 class="text-neon-green text-xs uppercase font-bold mb-2 font-arcade">ESTRATEGIA</h4>
                    <p id="briefStrat" class="text-white font-bold">...</p>
                </div>
                <div class="bg-neon-red/20 p-3 rounded text-neon-red text-xs font-mono border border-neon-red/50">
                    ‚ö†Ô∏è VELOCIDAD INCREMENTAL: Un error elimina la p√°gina.
                </div>
            </div>
            <button onclick="startGame()" class="w-full mt-6 bg-white text-black font-arcade py-4 hover:bg-neon-cyan transition shadow-[0_0_20px_white] text-sm md:text-base font-bold">
                ¬°INICIAR JUEGO! (ENTER)
            </button>
        </div>
    </div>

    <!-- SCREEN 3: GAMEPLAY -->
    <div id="screenGame" class="hidden absolute inset-0 z-10 flex flex-col bg-transparent">
        
        <!-- HUD Overlay -->
        <div class="absolute top-0 left-0 right-0 z-40 pointer-events-none">
            <div class="progress-container"><div id="progressBar" class="progress-fill"></div></div>
            
            <div class="flex justify-between p-2 mt-4">
                <!-- LEFT PANEL: ALGO & SCORE (Stacked) -->
                <div class="glass-panel px-4 py-3 rounded-r-lg border-l-4 border-neon-cyan flex flex-col gap-2 min-w-[140px]">
                    <div>
                        <div class="text-[8px] text-gray-400 uppercase font-arcade mb-1">Modo</div>
                        <div id="hudAlgo" class="text-lg font-bold text-white leading-none">--</div>
                    </div>
                    <div class="border-t border-gray-600 pt-2">
                        <div class="text-[8px] text-gray-400 uppercase font-arcade mb-1">Score</div>
                        <div id="hudScore" class="text-xl font-bold text-neon-yellow leading-none font-arcade">0</div>
                    </div>
                </div>

                <!-- RIGHT PANEL: COMBO -->
                <div class="glass-panel px-4 py-2 rounded-l-lg text-right border-r-4 border-neon-green h-fit">
                    <div class="text-[8px] text-gray-400 uppercase font-arcade">Combo</div>
                    <div id="hudCombo" class="text-xl font-bold text-neon-green">x1</div>
                </div>
            </div>
            
            <!-- FEEDBACK CENTER -->
            <div class="text-center mt-4">
                <div id="feedbackText" class="h-8 text-3xl font-arcade text-white drop-shadow-md transition-transform scale-0"></div>
            </div>
        </div>

        <!-- HIGHWAY -->
        <div class="relative flex-1 w-full max-w-3xl mx-auto border-l border-r border-white/10 bg-gradient-to-b from-transparent to-black/90 overflow-hidden">
            <div id="visualHitLine" class="hit-zone-line"></div>
            <div class="absolute bottom-[205px] left-2 text-[8px] text-neon-cyan font-arcade opacity-60">TARGET</div>
            
            <div id="layerNotes" class="absolute inset-0 pointer-events-none"></div>

            <div class="absolute top-24 right-2 w-16 opacity-70">
                <div class="text-[8px] text-neon-cyan mb-1 font-arcade text-right">NEXT</div>
                <div id="queueList" class="flex flex-col gap-2 items-end"></div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="h-44 bg-black border-t border-white/20 z-50 flex justify-center items-center gap-2 p-2 pb-8 shadow-[0_-10px_30px_black]">
            
            <!-- BTN 0 -->
            <div id="btn-0" class="control-pad relative w-1/3 max-w-[140px] h-32 bg-gray-900 border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center active:border-white active:bg-gray-800 transition-all shadow-lg cursor-pointer select-none">
                <div class="absolute top-2 left-2 text-[8px] text-gray-500 font-arcade">0</div>
                <div class="absolute top-2 right-2 hidden md:block text-[8px] text-gray-500 font-arcade border px-1 rounded">A</div>
                <div id="val-0" class="flex items-center justify-center h-full w-full text-5xl font-arcade text-white z-10 pointer-events-none pb-2">--</div>
                <div id="bar-0" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all rounded-b-xl"></div>
            </div>

            <!-- BTN 1 -->
            <div id="btn-1" class="control-pad relative w-1/3 max-w-[140px] h-32 bg-gray-900 border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center active:border-white active:bg-gray-800 transition-all shadow-lg cursor-pointer select-none">
                <div class="absolute top-2 left-2 text-[8px] text-gray-500 font-arcade">1</div>
                <div class="absolute top-2 right-2 hidden md:block text-[8px] text-gray-500 font-arcade border px-1 rounded">S</div>
                <div id="val-1" class="flex items-center justify-center h-full w-full text-5xl font-arcade text-white z-10 pointer-events-none pb-2">--</div>
                <div id="bar-1" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all rounded-b-xl"></div>
            </div>

            <!-- BTN 2 -->
            <div id="btn-2" class="control-pad relative w-1/3 max-w-[140px] h-32 bg-gray-900 border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center active:border-white active:bg-gray-800 transition-all shadow-lg cursor-pointer select-none">
                <div class="absolute top-2 left-2 text-[8px] text-gray-500 font-arcade">2</div>
                <div class="absolute top-2 right-2 hidden md:block text-[8px] text-gray-500 font-arcade border px-1 rounded">D</div>
                <div id="val-2" class="flex items-center justify-center h-full w-full text-5xl font-arcade text-white z-10 pointer-events-none pb-2">--</div>
                <div id="bar-2" class="absolute bottom-0 left-0 right-0 h-1 bg-neon-red transition-all rounded-b-xl"></div>
            </div>

        </div>
    </div>

    <!-- SCREEN 4: PAUSE -->
    <div id="screenPause" class="hidden absolute inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-6 backdrop-blur-md">
        <h2 class="text-5xl font-arcade text-white mb-8 tracking-widest">PAUSA</h2>
        <div class="w-full max-w-sm bg-gray-900/50 p-6 rounded-lg border border-gray-700 mb-8 text-center">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <div class="text-[10px] text-gray-500 uppercase">MODO</div>
                    <div id="pauseAlgo" class="text-xl text-neon-cyan font-bold">--</div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-500 uppercase">SCORE</div>
                    <div id="pauseScore" class="text-xl text-white font-arcade">0</div>
                </div>
            </div>
            <div class="text-[10px] text-gray-500 uppercase">PROGRESO</div>
            <div id="pauseProgress" class="text-2xl text-neon-pink font-bold">0%</div>
        </div>
        <div class="flex flex-col gap-4 w-full max-w-sm">
            <div id="pause-btn-0" class="menu-btn bg-neon-green text-black font-arcade py-4 rounded hover:bg-white transition shadow-lg cursor-pointer" onclick="togglePause()">
                ‚ñ∂ REANUDAR (Enter)
            </div>
            <div id="pause-btn-1" class="menu-btn border-2 border-gray-600 text-gray-400 font-arcade py-4 rounded hover:border-white hover:text-white transition cursor-pointer" onclick="goToMenu()">
                ‚ö† ABANDONAR
            </div>
        </div>
        <div class="mt-4 text-xs text-gray-500 font-mono">Usa ‚Üë ‚Üì y Enter</div>
    </div>

    <!-- SCREEN 5: GAME OVER -->
    <div id="screenOver" class="hidden absolute inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-6">
        <h2 class="text-5xl md:text-7xl text-neon-red font-arcade mb-8 text-center animate-pulse drop-shadow-[0_0_20px_red]">SYSTEM<br>FAILURE</h2>
        <div class="glass-panel w-full max-w-md p-8 rounded-xl border border-neon-red text-center shadow-[0_0_50px_rgba(255,0,0,0.2)]">
            <p class="text-gray-400 font-arcade text-xs uppercase mb-2">SCORE FINAL</p>
            <p id="finalScore" class="text-6xl text-white font-arcade mb-8">0</p>
            <div class="flex flex-col gap-4">
                <button onclick="restartGame()" class="bg-white text-black font-arcade py-3 hover:bg-neon-green hover:scale-105 transition shadow-lg">
                    ‚Üª REINTENTAR
                </button>
                <button onclick="goToMenu()" class="bg-transparent border border-gray-600 text-gray-400 font-arcade py-3 hover:border-white hover:text-white transition">
                    ‚Üê MEN√ö
                </button>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = false;

        function toggleAudio() {
            soundEnabled = !soundEnabled;
            const buttons = document.querySelectorAll('#btnAudio');
            buttons.forEach(btn => {
                if (soundEnabled) {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    btn.innerText = "üîä ON";
                    btn.style.borderColor = "#00ff66";
                    btn.style.color = "#00ff66";
                    playSound('select');
                } else {
                    btn.innerText = "üîá OFF";
                    btn.style.borderColor = "#4b5563";
                    btn.style.color = "#9ca3af";
                }
            });
        }

        const sounds = {
            select: { freq: 440, type: 'square', dur: 0.1 },
            move: { freq: 220, type: 'sawtooth', dur: 0.05 },
            hit: { freq: 880, type: 'sine', dur: 0.1, slide: 1200 },
            load: { freq: 600, type: 'square', dur: 0.15 },
            replace: { freq: 400, type: 'sawtooth', dur: 0.2 },
            error: { freq: 100, type: 'sawtooth', dur: 0.3, slide: 50 },
            over: { freq: 150, type: 'sawtooth', dur: 1.0, slide: 20 }
        };

        function playSound(name) {
            if (!soundEnabled) return;
            const s = sounds[name];
            if (!s) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = s.type;
            osc.frequency.setValueAtTime(s.freq, audioCtx.currentTime);
            if (s.slide) osc.frequency.exponentialRampToValueAtTime(s.slide, audioCtx.currentTime + s.dur);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + s.dur);
        }

        const BASE_SPEED = 180; 
        const MAX_SPEED = 700;
        const HIT_TOLERANCE = 55;
        const TOTAL_QUEUE_SIZE = 100;

        let state = {
            screen: 'screenMenu', 
            algo: 'FIFO',
            active: false,
            paused: false,
            score: 0,
            combo: 1,
            memory: [null, null, null],
            meta: [0, 0, 0],
            queue: [],
            notes: [],
            lastTime: 0,
            spawnTimer: 0,
            idCounter: 0,
            currentSpeed: BASE_SPEED,
            selectedMenuIdx: 0,
            selectedPauseIdx: 0
        };

        /* --- SCREEN MANAGER --- */
        function showScreen(id) {
            const screens = ['screenMenu', 'screenBriefing', 'screenGame', 'screenPause', 'screenOver'];
            screens.forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            
            const target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
            
            state.screen = id;

            const pauseBtn = document.getElementById('btnPauseTop');
            if (id === 'screenGame') pauseBtn.classList.remove('hidden');
            else pauseBtn.classList.add('hidden');
        }

        /* --- NAVIGATION --- */
        function prepareBriefing(algo) {
            playSound('select');
            state.algo = algo;
            showScreen('screenBriefing');
            
            const title = document.getElementById('briefTitle');
            const desc = document.getElementById('briefDesc');
            const strat = document.getElementById('briefStrat');
            
            title.innerText = algo;
            
            if (algo === 'FIFO') {
                title.style.color = '#ffe600';
                desc.innerText = "First-In, First-Out. Las p√°ginas entran en orden. La v√≠ctima es la M√ÅS VIEJA (la que lleg√≥ primero).";
                strat.innerText = "REEMPLAZA LA BARRA ROJA M√ÅS LLENA.";
            } else if (algo === 'LRU') {
                title.style.color = '#00f3ff';
                desc.innerText = "Least Recently Used. Basado en uso real. La v√≠ctima es la que hace M√ÅS TIEMPO que no se usa.";
                strat.innerText = "HIT = REFRESCO. REEMPLAZA LA BARRA ROJA M√ÅS LLENA.";
            } else {
                title.style.color = '#ff00ff';
                desc.innerText = "Optimal. Mira al futuro. La v√≠ctima es la que tardar√° M√ÅS TIEMPO en volver a necesitarse.";
                strat.innerText = "MIRA LA LISTA 'NEXT'. ELIMINA LA QUE NO EST√â O EST√â AL FONDO.";
            }
        }

        function startGame() {
            playSound('select');
            showScreen('screenGame');
            
            const hudAlgo = document.getElementById('hudAlgo');
            if (hudAlgo) {
                hudAlgo.innerText = state.algo;
                let color = state.algo === 'FIFO' ? 'text-neon-yellow' : (state.algo === 'LRU' ? 'text-neon-cyan' : 'text-neon-pink');
                hudAlgo.className = `text-lg font-bold font-cyber ${color} drop-shadow-md`;
            }

            resetState();
            generateQueue();
            state.active = true;
            state.paused = false;
            state.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function restartGame() {
            startGame();
        }

        function goToMenu() {
            playSound('select');
            state.active = false;
            showScreen('screenMenu');
            updateMenuSelection();
        }

        function togglePause() {
            if (state.screen !== 'screenGame' && state.screen !== 'screenPause') return;
            
            state.paused = !state.paused;
            if (state.paused) {
                const processed = TOTAL_QUEUE_SIZE - state.queue.length;
                const pct = Math.floor((processed / TOTAL_QUEUE_SIZE) * 100);
                document.getElementById('pauseAlgo').innerText = state.algo;
                document.getElementById('pauseScore').innerText = state.score;
                document.getElementById('pauseProgress').innerText = pct + "%";
                state.selectedPauseIdx = 0; 
                updatePauseSelection();
                showScreen('screenPause');
            } else {
                showScreen('screenGame');
                state.lastTime = performance.now();
                requestAnimationFrame(gameLoop);
            }
        }

        function resetState() {
            state.score = 0;
            state.combo = 1;
            state.memory = [null, null, null];
            state.meta = [0, 0, 0];
            state.queue = [];
            state.notes = [];
            state.spawnTimer = 0;
            state.currentSpeed = BASE_SPEED;
            
            const layerNotes = document.getElementById('layerNotes');
            if(layerNotes) layerNotes.innerHTML = '';
            
            const progressBar = document.getElementById('progressBar');
            if(progressBar) progressBar.style.width = '0%';
            
            updateHUD();
            updateFrames();
        }

        /* --- INPUTS --- */
        const btns = [0, 1, 2];
        btns.forEach(id => {
            const el = document.getElementById(`btn-${id}`);
            if (el) {
                el.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleGameInput(id);
                    el.classList.add('border-white', 'scale-95');
                    setTimeout(() => el.classList.remove('border-white', 'scale-95'), 100);
                }, { passive: false });
                el.addEventListener('mousedown', (e) => {
                    handleGameInput(id);
                    el.classList.add('border-white', 'scale-95');
                    setTimeout(() => el.classList.remove('border-white', 'scale-95'), 100);
                });
            }
        });

        const menuItems = document.querySelectorAll('.menu-item');
        function updateMenuSelection() {
            menuItems.forEach((el, idx) => {
                if (idx === state.selectedMenuIdx) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function updatePauseSelection() {
            const pauseBtns = [document.getElementById('pause-btn-0'), document.getElementById('pause-btn-1')];
            pauseBtns.forEach((el, idx) => {
                if (idx === state.selectedPauseIdx) {
                    el.classList.add('selected'); 
                    el.style.backgroundColor = '#fff';
                    el.style.color = '#000';
                } else {
                    el.classList.remove('selected');
                    el.style.backgroundColor = '';
                    el.style.color = '';
                }
            });
        }

        function handleMenuInput(key) {
            if (key === 'arrowdown' || key === 's') {
                state.selectedMenuIdx = (state.selectedMenuIdx + 1) % menuItems.length;
                playSound('move');
                updateMenuSelection();
            } else if (key === 'arrowup' || key === 'w') {
                state.selectedMenuIdx = (state.selectedMenuIdx - 1 + menuItems.length) % menuItems.length;
                playSound('move');
                updateMenuSelection();
            } else if (key === 'enter') {
                const algo = menuItems[state.selectedMenuIdx].getAttribute('data-algo');
                prepareBriefing(algo);
            }
        }

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'm') toggleAudio();

            if (state.screen === 'screenMenu') {
                handleMenuInput(key);
                return;
            }

            if (state.screen === 'screenBriefing') {
                if (key === 'enter') startGame();
                if (key === 'escape') goToMenu();
                return;
            }

            if (state.screen === 'screenPause') {
                if (key === 'escape' || key === 'p') {
                    togglePause();
                    return;
                }
                // Pause Menu Navigation
                if (key === 'arrowdown' || key === 's' || key === 'arrowup' || key === 'w') {
                    state.selectedPauseIdx = (state.selectedPauseIdx + 1) % 2; 
                    playSound('move');
                    updatePauseSelection();
                }
                if (key === 'enter') {
                    playSound('select');
                    if (state.selectedPauseIdx === 0) togglePause();
                    else goToMenu();
                }
                return;
            }

            if (state.screen === 'screenGame') {
                if (key === 'escape' || key === 'p') {
                    togglePause();
                    return;
                }
                if (!state.paused) {
                    const map = { '1': 0, 'a': 0, '2': 1, 's': 1, '3': 2, 'd': 2 };
                    if (map.hasOwnProperty(key)) {
                        const id = map[key];
                        handleGameInput(id);
                        const el = document.getElementById(`btn-${id}`);
                        if(el) {
                            el.classList.add('border-white', 'scale-95');
                            setTimeout(() => el.classList.remove('border-white', 'scale-95'), 100);
                        }
                    }
                }
            }
        });

        /* --- GAME LOOP --- */
        function generateQueue() {
            state.queue = [];
            for(let i=0; i<TOTAL_QUEUE_SIZE; i++) {
                if (i>3 && Math.random() < 0.5) state.queue.push(state.queue[i-1] || 0);
                else state.queue.push(Math.floor(Math.random() * 8));
            }
            updateQueueVis();
        }

        function gameLoop(timestamp) {
            if (!state.active || state.paused) return;
            const dt = (timestamp - state.lastTime) / 1000;
            state.lastTime = timestamp;
            updateGame(dt);
            requestAnimationFrame(gameLoop);
        }

        function updateGame(dt) {
            if (state.currentSpeed < MAX_SPEED) state.currentSpeed += (dt * 10);
            
            state.spawnTimer -= dt;
            if (state.spawnTimer <= 0 && state.queue.length > 0) {
                spawnNote();
                const rate = Math.max(0.6, 2.2 - ((state.currentSpeed - BASE_SPEED) / 400));
                state.spawnTimer = rate;
            }

            const targetY = window.innerHeight - 200;
            let activeInZone = false;

            state.notes.forEach(note => {
                note.y += state.currentSpeed * dt;
                note.el.style.top = `${note.y}px`;
                const dist = Math.abs((note.y + 35) - targetY);
                if (dist < HIT_TOLERANCE && !note.missed) activeInZone = true;
                if (!note.missed && note.y > targetY + HIT_TOLERANCE + 20) {
                    note.missed = true;
                    handleMiss(note);
                }
            });

            const line = document.getElementById('visualHitLine');
            if(line) {
                if (activeInZone) line.classList.add('active'); else line.classList.remove('active');
            }

            state.notes = state.notes.filter(n => n.y < window.innerHeight + 100);
            const pct = 100 - ((state.queue.length / TOTAL_QUEUE_SIZE) * 100);
            const progressBar = document.getElementById('progressBar');
            if(progressBar) progressBar.style.width = `${pct}%`;

            if (state.queue.length === 0 && state.notes.length === 0) endGame();
        }

        function spawnNote() {
            const val = state.queue.shift();
            updateQueueVis();
            const el = document.createElement('div');
            let color = state.algo === 'FIFO' ? 'bg-neon-yellow border-neon-yellow text-black' : 
                        (state.algo === 'LRU' ? 'bg-neon-cyan border-neon-cyan text-black' : 'bg-neon-pink border-neon-pink text-black');
            el.className = `note absolute border-4 font-bold text-2xl ${color} shadow-[0_0_20px_currentColor]`;
            el.style.width = '70px'; el.style.height = '70px';
            el.style.top = '-80px'; 
            el.innerText = val;
            
            const layerNotes = document.getElementById('layerNotes');
            if(layerNotes) layerNotes.appendChild(el);
            state.notes.push({ id: state.idCounter++, val: val, y: -80, el: el, missed: false });
        }

        function handleGameInput(frameIdx) {
            const targetY = window.innerHeight - 200;
            let activeNote = null;
            let minDist = Infinity;

            state.notes.forEach(n => {
                if (n.missed) return;
                const dist = Math.abs((n.y + 35) - targetY);
                if (dist < HIT_TOLERANCE && dist < minDist) {
                    minDist = dist;
                    activeNote = n;
                }
            });

            if (!activeNote) return;

            const page = activeNote.val;
            const memVal = state.memory[frameIdx];
            let success = false;
            let type = '';

            if (state.memory.includes(page)) {
                if (memVal === page) {
                    success = true; type = 'HIT';
                    if (state.algo === 'LRU') state.meta[frameIdx] = Date.now();
                }
            } else {
                if (state.memory.includes(null)) {
                    if (memVal === null) {
                        success = true; type = 'LOAD';
                        state.memory[frameIdx] = page;
                        if (state.algo !== 'OPT') state.meta[frameIdx] = Date.now();
                    }
                } else {
                    if (checkVictim(frameIdx)) {
                        success = true; type = 'REPLACE';
                        state.memory[frameIdx] = page;
                        if (state.algo !== 'OPT') state.meta[frameIdx] = Date.now();
                    }
                }
            }

            if (success) {
                if (type === 'HIT') playSound('hit');
                else if (type === 'LOAD') playSound('load');
                else playSound('replace');
                showFeedback("GOOD!", "text-neon-green");
                activeNote.missed = true;
                activeNote.el.style.transform = "scale(1.5)";
                activeNote.el.style.opacity = "0";
                setTimeout(() => { if(activeNote.el.parentNode) activeNote.el.remove(); }, 200);
                state.score += (100 * state.combo);
                state.combo = Math.min(8, state.combo + 1);
            } else {
                playSound('error');
                showFeedback("ERROR!", "text-neon-red");
                state.combo = 1;
                state.score = Math.max(0, state.score - 50);
                activeNote.missed = true;
                activeNote.el.classList.add('bg-neon-red', 'border-neon-red');
                activeNote.el.style.transform = "scale(0.8) rotate(20deg)";
                activeNote.el.style.opacity = "0";
                setTimeout(() => { if(activeNote.el.parentNode) activeNote.el.remove(); }, 200);
            }
            updateHUD();
            updateFrames();
        }

        function checkVictim(idx) {
            if (state.algo === 'FIFO' || state.algo === 'LRU') {
                let min = Infinity; let v = -1;
                state.meta.forEach((val, i) => { if (val < min) { min = val; v = i; } });
                return idx === v;
            }
            if (state.algo === 'OPT') {
                let maxDist = -1; let v = -1;
                state.memory.forEach((memPage, i) => {
                    let dist = state.queue.indexOf(memPage);
                    if (dist === -1) dist = 9999;
                    if (dist > maxDist) { maxDist = dist; v = i; }
                });
                return idx === v;
            }
            return false;
        }

        function handleMiss(note) {
            playSound('error');
            showFeedback("MISS", "text-gray-500");
            state.combo = 1;
            state.score = Math.max(0, state.score - 50);
            updateHUD();
            note.el.style.opacity = 0.5;
            note.el.style.filter = "grayscale(100%)";
        }

        function updateHUD() {
            const hudScore = document.getElementById('hudScore');
            if(hudScore) hudScore.innerText = state.score.toString();
            
            const hudCombo = document.getElementById('hudCombo');
            if(hudCombo) hudCombo.innerText = `x${state.combo}`;
        }

        function updateFrames() {
            state.memory.forEach((val, i) => {
                const valEl = document.getElementById(`val-${i}`);
                if(valEl) valEl.innerText = val !== null ? val : "--";
                
                const bar = document.getElementById(`bar-${i}`);
                if(bar) {
                    let h = 0;
                    if (val !== null && state.algo !== 'OPT') {
                        const age = Date.now() - state.meta[i];
                        h = Math.min(100, age / 5000 * 100);
                    }
                    bar.style.height = `${h}%`;
                    bar.style.backgroundColor = h > 80 ? '#ff0033' : '#334155';
                }
            });
        }

        function updateQueueVis() {
            const list = document.getElementById('queueList');
            if(list) {
                list.innerHTML = state.queue.slice(0, 5).map(v => 
                    `<div class="bg-gray-800 text-white w-8 h-8 flex items-center justify-center rounded border border-gray-600 font-arcade text-xs">${v}</div>`
                ).join('');
            }
        }

        function showFeedback(txt, colorClass) {
            const el = document.getElementById('feedbackText');
            if(el) {
                el.innerText = txt;
                el.className = `h-12 text-3xl md:text-5xl font-arcade drop-shadow-md transition-all scale-125 italic ${colorClass}`;
                setTimeout(() => { el.classList.remove('scale-125'); el.classList.add('scale-0'); }, 500);
            }
        }

        function endGame() {
            state.active = false;
            playSound('over');
            const finalScore = document.getElementById('finalScore');
            if(finalScore) finalScore.innerText = state.score;
            showScreen('screenOver');
        }

        updateMenuSelection();
    </script>
</body>
</html>
